name: Build
on:
  push:
    branches:
      - stage # or the name of your main branch

jobs:
  build:
    name: Build
    runs-on: ubuntu-latest
    steps:

      - uses: actions/checkout@v2
        with:
         fetch-depth: 0  # Shallow clones should be disabled for a better relevancy of analysis

      # Setup gcloud CLI
      - uses: google-github-actions/setup-gcloud@94337306dda8180d967a56932ceb4ddcf01edae7
        with:
          service_account_key: ${{ secrets.GKE_SA_KEY }}
          project_id: ${{ secrets.GKE_PROJECT }}

      # Get the GKE credentials so we can deploy to the cluster
      - uses: google-github-actions/get-gke-credentials@fb08709ba27618c31c09e014e1d8364b02e5042e
        with:
          cluster_name: champion2
          location: us-west1-a
          credentials: ${{ secrets.GKE_SA_KEY }}
       # Deploy the Docker image to the GKE cluster
      - name: Deploy
        run: |
              
               cd backend1-kustomize-stage
               kubectl create namespace stage 
               kubectl apply -f .

       # Check the sonarqube report here
      - name: Check the sonarqube report here
        run: | 
              SONAR_URL=`kubectl get svc sonarqube-sonarqube --output jsonpath='{.status.loadBalancer.ingress[0].ip}' -n sonarqube`
              echo "The SonarQube Reports are available at $SONAR_URL"

      # Wait for 60 seconds and get the preview of the applicaton 
      #- name: Wait for 60 seconds and get the preview of the applicaton
      #  run: | 
      #    sleep 60
      #    PRIVEW_URL=`kubectl get svc -n customer1-frontend-lb-myapp  --output jsonpath='{.status.loadBalancer.ingress[0].ip}' -n stage`
      #    echo "This is app preview URL $PRIVEW_URL" 
      # Delete stage namespace 
      #- name: Delete stage namespace
      #  run: | 
      #    sleep 60
      #    kubectl delete namespace stage          